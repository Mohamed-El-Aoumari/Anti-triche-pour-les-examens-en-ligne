<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Examen en Cours</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        #rawVideo, #captureCanvas { display: none; }
    </style>
</head>
<body class="exam-mode">

<div class="exam-container">
    
    <div class="subject-area">
        <div class="d-flex justify-content-between">
            <h2>{{ exam.title }}</h2>
            <span class="badge bg-primary">Session ID: {{ exam_session.id }}</span>
        </div>
        <hr>
        <p class="text-muted">R√©pondez aux questions ci-dessous. Votre comportement est analys√© en temps r√©el.</p>
        
        <div class="mb-4">
            <h5>Question 1</h5>
            <p>Quelle m√©thode d‚Äôapprentissage n‚Äôest pas adapt√©e pour la grande dimension ? Justifier.</p>
            <textarea class="form-control" rows="4"></textarea>
        </div>

        <div class="mb-4">
            <h5>Question 2</h5>
            <p>Avec quel algorithme obtient-on la solution du probl√®me du Lasso ? Expliquez son it√©ration principale formellement ?</p>
            <textarea class="form-control" rows="4"></textarea>
        </div>

        <button class="btn btn-success btn-lg w-100 mt-4">TERMINER L'EXAMEN</button>
    </div>

    <div class="camera-area">
        <h4 class="mb-3">üî¥ Surveillance Active</h4>
        
        <video id="rawVideo" autoplay playsinline></video>
        <canvas id="captureCanvas"></canvas>

        <img id="processedFeed" src="" class="camera-feed" alt="Initialisation cam√©ra...">
        
        <div id="warningBox" class="warning-box text-center">
            <strong>ATTENTION</strong><br>
            <span id="statusText">
                Gardez votre visage dans le cadre.<br>
                Ne regardez pas autour de vous.<br>
                Pas de t√©l√©phone.
            </span>
        </div>
        
        <div class="mt-4">
            <a href="{{ url_for('student_home') }}" class="btn btn-outline-light btn-sm">Quitter (Urgence)</a>
        </div>
    </div>

</div>

<script>
    const sessionId = {{ exam_session.id }};
    const video = document.getElementById('rawVideo');
    const canvas = document.getElementById('captureCanvas');
    const processedFeed = document.getElementById('processedFeed');
    const warningBox = document.getElementById('warningBox');
    const statusText = document.getElementById('statusText');
    const ctx = canvas.getContext('2d');

    // Acc√®s cam√©ra
    navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
            video.srcObject = stream;
        })
        .catch(err => {
            console.error("Erreur cam√©ra:", err);
            alert("Impossible d'acc√©der √† la cam√©ra !");
        });

    setInterval(() => {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            // Capture
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageData = canvas.toDataURL('image/jpeg', 0.6);
            
            fetch('/process_frame', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    session_id: sessionId,
                    image: imageData
                })
            })
            .then(response => response.json())
            .then(data => {
                if(data.status === 'ok') {
                    processedFeed.src = data.image;
                    
                    if (data.is_alert) {
                        warningBox.style.backgroundColor = "rgba(220, 53, 69, 0.4)"; 
                        statusText.innerHTML = `<strong>‚ö†Ô∏è ALERTE (${(data.cheat_rate*100).toFixed(0)}%)</strong><br>Comportement suspect d√©tect√©.`;
                    } else {
                        warningBox.style.backgroundColor = "rgba(220, 53, 69, 0.1)";
                        statusText.innerHTML = "Gardez votre visage dans le cadre.<br>Ne regardez pas autour de vous.<br>Pas de t√©l√©phone.";
                    }
                }
            })
            .catch(err => console.error(err));
        }
    }, 200); 
</script>

</body>
</html>